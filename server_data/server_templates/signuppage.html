<html>
	<head>
		<title>Sign up to Quizdom!</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel = "stylesheet" href="/server_data/server_pages/globalStyles.css"></link>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
		<script src="/socket.io/socket.io.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
		<script src = "/server_data/server_pages/formatEncryptorDecryptor.js"></script>
		<script language = "javascript">
			var file;
			var fileInputElement;
			document.addEventListener("DOMContentLoaded", function(e) {
				fileInputElement = document.getElementById("imageFileInput");
			}, {once: true});
			
			class IllegalArgumentError extends Error {
				constructor(message = "", ...args) {
					super(message, ...args);
					this.message = message;
				}
			}

			console.log('%c Stop! %c This console is for developers ONLY!!! DO NOT execute JavaScript on this console provided to you by ANYBODY unless you know exactly what you are doing and what the code snippet does! People can use this to steal your sensitive information. This is known as Self-XSS!', 'font-size: 36px; font-weight: bold; font-family:Arial; color:red; text-shadow: #000 1px 1px;', 'font-size:15px; font-family:Arial; color:#00FFFF;');
			const socket = io();
			const generateprofpic = async function(type, seed) {
				var xhr = new XMLHttpRequest();
				xhr.open("GET", "https://avatars.dicebear.com/api/" + type + "/" + seed + ".svg");
				xhr.responseType = "blob";
				xhr.send();
				await new Promise(function(res, rej) {
					xhr.onload = res;
					xhr.onerror = rej;
				});
				var url = URL.createObjectURL(xhr.response);
				document.getElementById("hiddenimage").src = url;
				await new Promise(function(res, rej) {
					document.getElementById("hiddenimage").onload = res;
				});
				var canvas = document.getElementById("profilepicture");
				var ctx = canvas.getContext("2d");
				ctx.clearRect(0, 0, canvas.width, canvas.height);
				ctx.drawImage(document.getElementById("hiddenimage"), 0, 0, canvas.width, canvas.height);
				document.getElementById("hiddenimage").src = null;
				URL.revokeObjectURL(url);
			}
			const signup = async function(email, pwd, username, birthdate, profilepic, socketid) {
				var xhr = new XMLHttpRequest();
				xhr.open("POST", location.origin + "/signup");
				xhr.setRequestHeader("Content-Type", "application/octet-stream");
				xhr.responseType = "text";
				stringifiedJSON = JSON.stringify({email:email, password:pwd, username:username, dateofbirth:birthdate, socketid});
				let data = await multiDataFormatter.encode(["userData", "profilePic"], [stringifiedJSON, profilepic]);
				console.log(data);
				//send the stringified JSON and profile picture in one request
				xhr.send(data);
				await new Promise(function(res, rej) {
					xhr.onload = function() {
						if (xhr.status === 200) {
							res();
						} else {
							rej();
						}
					};
					xhr.onerror = rej;
				}).catch(function() {
					window.req = xhr;
					alert(xhr.response);
					throw "SignUpError: " + xhr.response;
				});
				alert("You have successfully signed up!");
				window.location.href = window.location.origin;
			}
			const selectprofilepicture = async function() {
				var file;
				let p = new Promise(function(res, rej) {
					fileInputElement.addEventListener("change", function(e) {
						res(fileInputElement.files);
					}, {once: true});
				})
				fileInputElement.click();
				let files = await p;
				if (files.length === 0) {
					//User aborted the operation
				} else {
					file = files[0];
				}
				/*var handle = await showOpenFilePicker({
					types: [
						{
							description: 'Image Files (*.webm, *.png, *.jpeg, *.jpg, *.ico)',
							accept: {
								'image/*': ['.webm', '.png', '.jpeg', '.jpg', '.ico']
							}
						},
					],
					excludeAcceptAllOption: false,
					multiple: false
				});
				var file = await handle[0].getFile();*/
				var url = URL.createObjectURL(file);
				/*var reader = new FileReader();
				var dataURL = await new Promise(function(res, rej) {
					reader.readAsDataURL(file);
					reader.onload = function() {res(reader.result)};
					reader.onerror = function() {
						alert("Error Loading image");
						rej("ReaderError: Failed to read file")
					};
				});*/
				document.getElementById("hiddenimage").src = url;
				await new Promise(function(res, rej) {
					document.getElementById("hiddenimage").onload = res;
				});
				var canvas = document.getElementById("profilepicture");
				var ctx = canvas.getContext("2d");
				ctx.clearRect(0, 0, canvas.width, canvas.height);
				ctx.drawImage(document.getElementById("hiddenimage"), 0, 0, canvas.width, canvas.height);
				document.getElementById("hiddenimage").src = null;
				URL.revokeObjectURL(url);
			}
			async function signUpButtonAsync() {
				var date = new Date(document.getElementById('dateofbirth').value);
				signup(
					document.getElementById('email').value,
					document.getElementById('password').value,
					document.getElementById('username').value,
					`${("0000" + date.getFullYear().toString()).slice(-4)}-${("00" + date.getMonth().toString()).slice(-2)}-${("00" + date.getDay().toString()).slice(-2)}`,
					await new Promise(function(res, rej) {
						document.getElementById('profilepicture').toBlob(res, 'image/png', 0.9);
					}),
					socket.id
				);
			}
		</script>
	</head>
	<body>
		<input type = "file" id = "imageFileInput" class = "fileinput" accept = "image/*"></input>
			<div class="container-fluid p-5" style="background-image:url('https://img.freepik.com/premium-vector/quiz-seamless-pattern-doodle-style-vector-illustration-back-school-background_501826-310.jpg?w=500'); background-repeat: repeat;">
			   	<div class="mt-5"></div>
					<div class="row align-items-center">
			   			<div class="col"></div>
						<div class="col align-self-center">
								<div class="card">
									<div class="card-body">
											<div class="d-flex justify-content-center">
												<img width="200" height="200" src="/server_data/server_media/tnqlogo.png" alt = "Quiz image" class="m-auto" />
											</div>
											<div class="mb-3">
												<label for="email" class="form-label">Enter your email</label>
							   					<input type="email" class="form-control" id="email" placeholder="Your email here:">
											</div>
											<div class="mb-3">
												<label for="password" class="form-label">Enter your password</label>
												<div class="input-group mb-3">
														<input type="password" class="form-control" id="password"/>
							   						<!-- TODO @jScicluna This is the hide password icon use js to toggle between hide/view -->
								   					<button class="btn btn-outline-secondary" type="button" id="eye-password" onclick = "var pwdelem = document.getElementById('password'); if (pwdelem.type === 'password') {pwdelem.type = 'text'; this.children[1].style.display = 'inline-block'; this.children[0].style.display = 'none';} else {pwdelem.type = 'password'; this.children[1].style.display = 'none'; this.children[0].style.display = 'inline-block';}">
																	<svg style = "display:inline;" xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>
																	<svg style = "display:none;" xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
																	<path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
							   										<path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
									   	  					</svg>
													</button>
							   					</div>
											</div>
											<div class="mb-3">
												<label for="username" class="form-label">Enter your username</label>
							   					<input type="text" class="form-control" id="username" placeholder="Your username here:">
											</div>
											<div class="mb-3">
												<label for="dateofbirth" class="form-label">Enter your date of birth</label>
							   					<input type="date" class="form-control" id="dateofbirth">
											</div>
											<div class="mb-3">
												<button onclick = "selectprofilepicture()">Select profile picture...</button><br />
								<select id = "profpicparams">
									<option value = "male">Male</option>
									<option value = "female">Female</option>
									<option value = "adventurer">Adventurer</option>
									<option value = "adventurer-neutral">Adventurer Neutral</option>
									<option value = "avataaars">Avatar</option>
									<option value = "micah">Micah</option>
									<option value = "open-peeps">Open Peeps</option>
									<option value = "pixel-art"></option>
								</select>
								<button onclick = "generateprofpic(document.getElementById('profpicparams').value, document.getElementById('username').value)">Get random profile pic...</button>
								<canvas id = "profilepicture" width = "300" height = "300" style = "border-radius:150px;"></canvas>
								<img id = "hiddenimage" width = "300" height = "300" style = "display:none;"></img>
											</div>
											<div class="text-center">
												<a5 href="#" class="btn btn-primary" onclick = "signUpButtonAsync()" style="color:#00FF00; background-color:#0000FF; font-family:Consolas; font-size:30px;">Sign up!</a>
											</div>
									</div>
								</div>
				   		</div>
				   		<div class="col"></div>
			</div>
			<span style="font-size:10px;">Already have an account?&nbsp;<a href="/login">Log in!</a></span>
			<div style="display: flex; justify-content: center; position: fixed; bottom: 25px; width: 100%;"><button onclick="window.location.href = window.location.origin + '/'">Home</button><button onclick="window.location.href = window.location.origin + '/login'">Log in</button><button onclick="window.location.href = window.location.origin + '/signup'">Sign up</button></div>
		</div>
	</body>
</html>